<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PwaGuideBoston</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="manifest" href="manifest.json">

</head>

<body>

  <md-toolbar class="md-accent">
    <div class="md-toolbar-layout">
      <md-toolbar-row>
        <span>Boston Guide</span>
        <button id="btnNotification">Notify</button>
      </md-toolbar-row>
    </div>
  </md-toolbar>

  <app-root>Loading...</app-root>

  <script src="./push-client.js"></script>

</body>

<script type="text/javascript">
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      // Registration was successful
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }).catch(function(err) {
      // registration failed :(
      console.log('ServiceWorker registration failed: ', err);
    });
  }

  /*****************************************************************************
  *
  * Listen for the add to home screen events
  *
  ****************************************************************************/

  window.addEventListener('beforeinstallprompt', function(e) {
    console.log('[App] Showing install prompt');

    e.userChoice.then(function(choiceResult) {
      console.log(choiceResult.outcome);
    });
  });

  document.querySelector('#btnNotification').addEventListener('click', (e) => {
    // Request permission to send notifications
    Notification.requestPermission().then(() => {
      // Get a reference to the SW
      return navigator.serviceWorker.ready;
    }).then((sw) => {
      // Tell it to subscribe with the push server
      return sw.pushManager.subscribe({userVisibleOnly: true});
    }).then((subscription) => {
      // Send details about the subscription to the server
      return fetch('http://localhost:8000/push', {
        method: 'POST',
        body: JSON.stringify({action: 'subscribe', subscription: subscription}),
        headers: new Headers({'Content-Type': 'application/json'})
      });
    });
  });
</script>

</html>
